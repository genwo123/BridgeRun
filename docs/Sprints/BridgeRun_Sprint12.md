# 브릿지런 개발일지 (스프린트 12)

## 📅 개발 기간
2025년 4월 21일 ~ 2025년 5월 4일

## 👨‍💻 작성자
김건우

## 1. 주요 개발 목표 및 성과

스프린트 12에서는 로비 시스템과 팀 색상 선택 기능을 개선하여 게임 시작 전 플레이어 경험을 향상시키는 것을 목표로 했습니다:

* **팀 색상 선택 시스템 구현** - 크레이지 아케이드 스타일의 색상 선택 UI 및 기능 구현
* **수동 레디 시스템 도입** - 자동 레디 상태에서 플레이어가 직접 준비 상태를 설정하는 방식으로 변경
* **팀 밸런스 기반 게임 시작 조건** - 팀 간 인원수 균형과 최소 팀 수 조건 구현
* **게임 인스턴스 확장** - 게임 시작 시 팀 정보 유지를 위한 데이터 구조 및 기능 추가

## 2. 팀 선택 시스템 구현

### 2.1 문제 상황 및 해결 방안

기존 로비 시스템에서는 플레이어 팀이 자동으로 배정되어 전략적 팀 구성이 어려웠습니다. 플레이어들이 직접 팀을 선택할 수 있도록 하고, 게임 맵 전환 시에도 이 정보가 유지되도록 시스템을 개선했습니다.

**해결 방안:**
1. UMG_Lobby 위젯에 팀 색상 선택 UI 추가
2. PC_Lobby에 팀 선택 정보 전달 기능 구현
3. BridgeRunGameInstance 확장으로 맵 전환 시 팀 정보 유지
4. 팀 균형 검증 및 게임 시작 조건 구현

### 2.2 팀 색상 선택 UI 구현

UMG_Lobby 위젯에 4가지 색상(빨강, 파랑, 초록, 노랑)의 선택 버튼을 추가하고, 현재 선택된 팀을 시각적으로 표시했습니다:

![팀 색상 선택 UI](../Images/Sprints_img/sprint12/team_color_selection_ui.png)

*UMG_Lobby 위젯의 우측 상단에 추가된 4개의 팀 색상 버튼 (빨강, 파랑, 초록, 노랑)*

**주요 구현 내용:**
* 우측 상단에 팀 색상 버튼 4개 추가
* 선택된 팀에 시각적 표시(테두리 강조)
* 현재 각 팀의 인원수 표시

이 기능은 블루프린트로 구현되었으며, 각 팀 버튼의 OnClicked 이벤트에서 플레이어 컨트롤러로 팀 선택 정보를 전달합니다:

![팀 버튼 클릭 이벤트](../Images/Sprints_img/sprint12/team_button_click_blueprint.png)

*UMG_Lobby에서 팀 버튼의 OnClicked 이벤트 연결 블루프린트 노드들*

### 2.3 PC_Lobby 팀 정보 업데이트

플레이어가 팀을 선택할 때 서버에 정보를 전달하는 블루프린트 함수를 구현했습니다:

![ServerUpdatePlayerTeam 함수](../Images/Sprints_img/sprint12/server_update_player_team_blueprint.png)

*PC_Lobby 블루프린트의 ServerUpdatePlayerTeam 커스텀 이벤트*

이 함수는 "Run on Server" 설정으로 서버에서 실행되며, 플레이어 캐릭터(BP_Citizen)의 TeamID를 업데이트합니다. 캐릭터에 직접 접근하는 방식을 선택한 이유는 PlayerState 캐스팅 문제 때문이었습니다.

### 2.4 BridgeRunGameInstance 확장

게임 맵 전환 시 팀 정보가 유지되도록 GameInstance 클래스를 C++로 확장했습니다. 이 부분은 실제 C++로 구현되었으며, 다음 기능들이 추가되었습니다:

* 플레이어 팀 정보를 저장하는 구조체 및 배열
* 팀 정보 저장/조회 함수
* 팀 균형 검증 함수

팀 정보 저장 구조체 및 관련 함수는 기존 GameInstance 클래스의 확장으로 추가되었습니다.

## 3. 준비 상태 시스템 구현

### 3.1 수동 레디 시스템

기존 자동 레디 상태에서 플레이어가 직접 준비 상태를 설정하는 방식으로 변경했습니다:

![준비 상태 UI](../Images/Sprints_img/sprint12/ready_status_ui.png)

*로비 화면에서 플레이어별 준비 상태를 표시하는 UI*

**주요 구현 내용:**
* BP_Citizen에 bIsReady 변수 추가
* 준비 버튼 클릭 시 상태 토글
* 모든 플레이어가 준비되어야 게임 시작 가능하도록 조건 추가

이 기능은 블루프린트로 구현되었으며, 준비 버튼의 OnClicked 이벤트에서 서버 함수를 호출합니다:

![준비 버튼 클릭 이벤트](../Images/Sprints_img/sprint12/ready_button_click_blueprint.png)

*준비 버튼의 OnClicked 이벤트 블루프린트 노드들*

### 3.2 팀 균형 및 게임 시작 조건

팀 간 인원수 균형과 최소 팀 수 조건을 구현하여 게임 시작 버튼의 활성화 조건을 설정했습니다. 이 로직은 BridgeRunGameInstance C++ 클래스에 구현되었으며, 블루프린트에서 호출됩니다:

![게임 시작 조건 체크](../Images/Sprints_img/sprint12/game_start_condition_blueprint.png)

*GM_Lobby에서 게임 시작 조건을 검사하는 블루프린트 노드들*

GM_Lobby 블루프린트에서는 이 조건에 따라 게임 시작 버튼의 활성화 여부를 결정합니다.

## 4. 게임 맵 전환 및 팀 정보 유지

게임 시작 시 로비에서 설정한 팀 정보를 게임 맵으로 전달하기 위한 시스템을 구현했습니다:

### 4.1 GM_Lobby에서 팀 정보 저장

게임 시작 직전 모든 플레이어의 팀 정보를 GameInstance에 저장합니다. 이 기능은 블루프린트로 구현되었습니다:

![팀 정보 저장](../Images/Sprints_img/sprint12/team_info_save_blueprint.png)

*GM_Lobby의 게임 시작 함수에서 팀 정보를 저장하는 블루프린트 노드들*

### 4.2 GM_Game에서 팀 정보 복원

게임 맵에 플레이어가 접속할 때 GameInstance에서 팀 정보를 가져와 적용합니다. 이 기능도 블루프린트로 구현되었습니다:

![팀 정보 복원](../Images/Sprints_img/sprint12/team_info_restore_blueprint.png)

*GM_Game의 PostLogin 이벤트에서 팀 정보를 복원하는 블루프린트 노드들*

## 5. 구현 과정에서 발생한 문제점과 해결 방법

### 5.1 PlayerState 캐스팅 문제

PlayerState를 PS_BridgeRunPlayerState로 캐스팅하는 과정에서 문제가 발생했습니다:

**문제 상황:**
블루프린트에서 Cast To PS_BridgeRunPlayerState 노드가 항상 실패하는 현상이 발생했습니다.

![캐스팅 실패](../Images/Sprints_img/sprint12/casting_failure_blueprint.png)

*Cast To PS_BridgeRunPlayerState 노드가 실패하는 블루프린트*

**원인 분석:**
프로젝트 설정에서 PlayerState 클래스가 올바르게 설정되지 않았거나, GM_Lobby에서 사용하는 클래스와 불일치했습니다.

**해결 방법:**
1. 프로젝트 설정에서 기본 PlayerState 클래스를 PS_BridgeRunPlayerState로 명시적 설정
2. GM_Lobby의 클래스 기본값에서도 PlayerState 클래스 설정 확인
3. 임시 해결책으로 BP_Citizen에 직접 TeamID 설정

![임시 해결책](../Images/Sprints_img/sprint12/workaround_solution_blueprint.png)

*PlayerState 대신 BP_Citizen에 직접 접근하여 TeamID를 설정하는 블루프린트*

### 5.2 게임 맵 전환 시 팀 정보 유실 문제

게임 맵으로 전환할 때 로비에서 설정한 팀 정보가 유지되지 않는 문제가 발생했습니다:

**문제 상황:**
로비에서 빨강, 파랑, 노랑, 초록팀을 선택했지만, 게임 맵에서는 항상 기본 배정(빨강, 파랑)으로 되돌아갔습니다.

**원인 분석:**
1. GameInstance에 팀 정보가 올바르게 저장되지 않음
2. GM_Game의 PostLogin에서 팀 정보를 복원하는 코드가 실행되지 않음
3. 기존 자동 팀 배정 로직이 새로운 팀 설정을 덮어씀

**해결 방법:**
1. GameInstance에 디버그 로그 추가하여 팀 정보 저장/복원 과정 추적
2. GM_Game의 PostLogin 함수에 디버그 출력 추가
3. BP_Citizen에서 Event OnRep_PlayerState 이벤트를 오버라이드하여 자동 팀 배정 로직 수정

**💡 원하는 이미지: OnRep_PlayerState 오버라이드 블루프린트**
*- BP_Citizen에서 OnRep_PlayerState 이벤트를 오버라이드한 블루프린트*
*- 자동 팀 배정 대신 GameInstance에서 저장된 팀 정보를 사용하는 로직*

## 6. 현재 구현 상태 및 성과

현재 로비 시스템과 팀 선택 기능이 다음과 같이 구현되었습니다:

### 6.1 구현 완료된 기능
* UMG_Lobby에 4가지 팀 색상 선택 UI 구현
* PC_Lobby의 ServerUpdatePlayerTeam 함수로 팀 정보 서버 전달
* BP_Citizen의 TeamID 및 레디 상태 관리
* BridgeRunGameInstance 확장으로 팀 정보 저장/복원 기능
* 팀 균형 및 게임 시작 조건 로직 구현

### 6.2 개선된 플레이어 경험
* 플레이어가 자신의 팀 색상을 직접 선택 가능
* 준비 상태를 통한 게임 시작 준비 표시
* 팀 밸런스 시스템으로 공정한 게임 환경 조성
* 게임 맵 전환 시에도 선택한 팀 정보 유지

### 6.3 실제 테스트 결과
데디케이티드 서버 환경에서 4명의 클라이언트로 테스트한 결과, 팀 선택 및 게임 시작 기능이 정상적으로 작동했습니다. 모든 플레이어가 서로 다른 팀을 선택하고 게임을 시작했을 때, 게임 맵에서도 선택한 팀 색상이 올바르게 유지되었습니다.

**💡 원하는 이미지: 로비 테스트 결과**
*- 4명의 클라이언트가 각각 다른 팀 색상을 선택한 로비 화면*
*- 게임 맵에서 선택한 팀 색상이 올바르게 적용된 캐릭터들*
*- 데디케이티드 서버에서 정상 작동하는 멀티플레이어 환경*

## 7. 다음 스프린트 계획

### 7.1 로비 시스템 마무리
* 로비 UI 디자인 개선 및 통일성 확보
* 플레이어 이름 표시 기능 추가
* 방장 권한 관리 기능 강화

### 7.2 게임 시작 카운트다운
* 5초 카운트다운 UI 및 로직 구현
* 블랙스크린 전환 효과 개선
* 취소 기능 추가

### 7.3 팀 시스템 확장
* 팀별 시작 위치 설정
* 팀 점수 표시 UI 개선
* 팀 기반 상호작용 규칙 구현

## 8. 회고 및 느낀점

이번 스프린트에서는 로비 시스템과 팀 선택 기능을 블루프린트를 활용하여 구현했습니다. GM_Lobby, PC_Lobby, UMG_Lobby 등 대부분의 작업이 블루프린트에서 이루어졌으며, C++ 코드 수정은 BridgeRunGameInstance 클래스 확장 부분에 국한되었습니다.

가장 어려웠던 부분은 PlayerState 캐스팅 문제였습니다. 블루프린트에서 Cast To PS_BridgeRunPlayerState 노드가 계속 실패했는데, 프로젝트 설정에서 PlayerState 클래스가 올바르게 지정되지 않았기 때문이었습니다. 이를 해결하기 위해 BP_Citizen에 직접 접근하는 블루프린트 로직을 구현했습니다.

게임 맵 전환 시 팀 정보 유지는 GameInstance를 활용하여 해결했습니다. C++로 확장된 BridgeRunGameInstance 클래스의 함수들을 블루프린트에서 호출하여 팀 정보를 저장하고 복원하는 방식으로 구현했습니다. 이 과정에서 레벨 간 데이터 전달 패턴의 중요성을 깨달았습니다.

블루프린트로 작업하면서 빠른 프로토타이핑이 가능했지만, 복잡한 로직을 구현할 때는 디버깅이 어려웠습니다. 특히 네트워크 관련 기능을 구현할 때 블루프린트만으로는 한계가 있었고, C++로 확장한 부분이 큰 도움이 되었습니다.

다음 스프린트에서도 블루프린트와 C++를 적절히 활용하여 로비 시스템을 개선하고, 게임 시작 카운트다운 및 팀 시스템 확장 작업을 진행할 예정입니다. 특히 방장 권한 관리와 같은 복잡한 로직은 C++로 구현하고, UI 관련 작업은 블루프린트로 진행하는 방식이 효율적일 것으로 예상됩니다.